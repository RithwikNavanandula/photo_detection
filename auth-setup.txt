// ================================================
// GOOGLE APPS SCRIPT - Authentication System
// ================================================
// 
// This script handles user authentication using Google Sheets as database.
// Free and easy to manage users (max ~20 users recommended).
//
// STEP 1: Create a Google Sheet for Users
// - Go to https://sheets.google.com
// - Create a new spreadsheet named "Label Scanner Users"
// - In Row 1, add these headers:
//   Username | Password | Name | Active
// - Add some users (example):
//   admin    | admin123 | Administrator | TRUE
//   user1    | pass1    | John Doe      | TRUE
//
// STEP 2: Create a NEW Google Apps Script Project
// - Go to https://script.google.com
// - Click "New Project"
// - Delete any existing code
// - Copy and paste the entire code below:

// ========== COPY FROM HERE ==========

// IMPORTANT: Replace this with your Google Sheet ID
// Find it in the Sheet URL: https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID/edit
const SHEET_ID = 'YOUR_SHEET_ID_HERE';
const SHEET_NAME = 'Sheet1';  // Or whatever your sheet tab is named

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    if (data.action === 'login') {
      return handleLogin(data.username, data.password);
    }
    
    return jsonResponse({ success: false, error: 'Unknown action' });
  } catch (error) {
    return jsonResponse({ success: false, error: error.toString() });
  }
}

function handleLogin(username, password) {
  if (!username || !password) {
    return jsonResponse({ success: false, error: 'Username and password required' });
  }
  
  try {
    const sheet = SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
    const data = sheet.getDataRange().getValues();
    
    // Skip header row (index 0)
    for (let i = 1; i < data.length; i++) {
      const row = data[i];
      const dbUsername = row[0]?.toString().toLowerCase();
      const dbPassword = row[1]?.toString();
      const dbName = row[2]?.toString();
      const isActive = row[3]?.toString().toUpperCase() === 'TRUE';
      
      if (dbUsername === username.toLowerCase() && dbPassword === password) {
        if (!isActive) {
          return jsonResponse({ success: false, error: 'Account is disabled' });
        }
        return jsonResponse({ 
          success: true, 
          username: dbUsername,
          name: dbName || dbUsername
        });
      }
    }
    
    return jsonResponse({ success: false, error: 'Invalid username or password' });
  } catch (error) {
    return jsonResponse({ success: false, error: 'Database error: ' + error.toString() });
  }
}

function jsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

function doGet(e) {
  return ContentService.createTextOutput('Label Scanner Auth API is running');
}

// ========== COPY UNTIL HERE ==========

// STEP 3: Get Your Sheet ID
// - Open your Google Sheet
// - Copy the ID from the URL:
//   https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID_HERE/edit
// - Paste it in the SHEET_ID variable above
//
// STEP 4: Deploy as Web App
// - Click the "Deploy" button (top right)
// - Select "New deployment"
// - Click the gear icon → Select "Web app"
// - Settings:
//   - Description: Label Scanner Auth
//   - Execute as: Me
//   - Who has access: Anyone
// - Click "Deploy"
// - Click "Authorize access" and allow permissions
//   (Click "Advanced" → "Go to project (unsafe)" → "Allow")
// - COPY THE WEB APP URL
//
// STEP 5: Add URL to Login Page
// - Open login.html
// - Find this line:
//   const AUTH_URL = '';
// - Paste your Web App URL between the quotes
//
// DONE! Users in your Google Sheet can now login to the app.
//
// MANAGING USERS:
// - Add user: Add a new row in the Sheet
// - Disable user: Set Active column to FALSE
// - Change password: Edit the Password column
// - Delete user: Delete the row
