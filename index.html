<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Label Scanner">
    <title>Label Scanner</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <!-- Auth Check -->
    <script>
        // Check if user is logged in
        const user = localStorage.getItem('user');
        if (!user) {
            window.location.href = '/';
        }
    </script>

    <div class="app">
        <!-- Header -->
        <header class="header">
            <div class="header-main">
                <h1>ğŸ“· Label Scanner</h1>
                <p>Scan product labels instantly</p>
            </div>
            <div class="header-user">
                <span id="user-name"></span>
                <div class="header-buttons">
                    <button id="admin-btn" class="admin-btn hidden" onclick="location.href='/admin'">ğŸ› ï¸
                        Dashboard</button>
                    <button id="logout-btn" class="logout-btn">ğŸšª Logout</button>
                </div>
            </div>
        </header>

        <!-- Quick Mode Toggle -->
        <div class="controls">
            <label class="quick-mode">
                <input type="checkbox" id="quick-mode">
                <span>ğŸš€ Quick Mode</span>
                <small>(ON = skip cropping, faster but less accurate)</small>
            </label>
        </div>

        <!-- Upload Button -->
        <div class="upload-section">
            <label for="file-input" class="upload-btn">ğŸ“ Choose Image</label>
            <input type="file" id="file-input" accept="image/*" capture="environment">
        </div>

        <!-- Batch Upload (Admin Only) -->
        <div id="batch-upload-section" class="batch-upload-section hidden">
            <label for="batch-file-input" class="upload-btn batch-btn">ğŸ“· Select Multiple Images</label>
            <input type="file" id="batch-file-input" accept="image/*" multiple>
            <small class="batch-hint">Admin: Select multiple photos to process in batch</small>
        </div>

        <!-- Batch Progress -->
        <div id="batch-progress" class="batch-progress hidden">
            <div class="progress-header">
                <span id="batch-status">Processing 0/0</span>
                <button id="cancel-batch" class="cancel-batch-btn">âŒ Cancel</button>
            </div>
            <div class="progress-bar">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>

        <!-- Results -->
        <div id="results" class="results hidden">
            <h2>ğŸ“‹ Results</h2>

            <!-- Photo Preview -->
            <img id="preview" class="preview" src="" alt="Preview">

            <!-- Data Fields (Editable) -->
            <div class="field">
                <label>ğŸ”¢ Batch No</label>
                <input type="text" id="batch" placeholder="Not found">
                <span id="conf-batch" class="badge"></span>
            </div>
            <div class="field">
                <label>ğŸ“… Mfg Date</label>
                <input type="text" id="mfg" placeholder="Not found">
                <span id="conf-mfg" class="badge"></span>
            </div>
            <div class="field">
                <label>â° Expiry Date</label>
                <input type="text" id="expiry" placeholder="Not found">
                <span id="conf-expiry" class="badge"></span>
            </div>
            <div class="field">
                <label>ğŸ¹ Flavour</label>
                <input type="text" id="flavour" placeholder="Not found">
            </div>
            <div class="field location-field">
                <label>ğŸ—„ï¸ Rack No</label>
                <input type="text" id="rack-no" list="rack-list" placeholder="Type or select...">
                <datalist id="rack-list">
                    <option value="Rack 1">
                    <option value="Rack 2">
                    <option value="Rack 3">
                    <option value="Rack 4">
                    <option value="Rack 5">
                </datalist>
            </div>
            <div class="field location-field">
                <label>ğŸ“š Shelf No</label>
                <input type="text" id="shelf-no" list="shelf-list" placeholder="Type or select...">
                <datalist id="shelf-list">
                    <option value="Shelf A">
                    <option value="Shelf B">
                    <option value="Shelf C">
                    <option value="Shelf D">
                    <option value="Shelf E">
                </datalist>
            </div>
            <div class="field inout-field">
                <label>ğŸ“¦ Movement</label>
                <div class="inout-toggle">
                    <button type="button" id="btn-in" class="inout-btn active" data-value="IN">â¬‡ï¸ IN</button>
                    <button type="button" id="btn-out" class="inout-btn" data-value="OUT">â¬†ï¸ OUT</button>
                </div>
                <input type="hidden" id="movement" value="IN">
            </div>

            <!-- Actions -->
            <div class="actions">
                <button id="save-btn" class="btn save">ğŸ’¾ Save</button>
                <button id="sheets-btn" class="btn sheets">ğŸ“Š Send to Sheets</button>
            </div>
            <div class="actions">
                <button id="clear-btn" class="btn clear">ğŸ”„ New Scan</button>
            </div>

            <!-- Continuous Mode -->
            <label class="continuous">
                <input type="checkbox" id="continuous">
                <span>âš¡ Auto-save & next</span>
            </label>

            <!-- Raw OCR -->
            <details class="raw-section">
                <summary>ğŸ“ Raw OCR Text</summary>
                <pre id="raw-text"></pre>
            </details>
        </div>

        <!-- History -->
        <div class="history-section">
            <div class="history-header">
                <h2>ğŸ“š History</h2>
                <div class="export-buttons">
                    <button id="sync-db-btn" class="btn sync-db">ğŸ”„ Sync to DB</button>
                    <button id="download-btn" class="btn export">ğŸ“¥ Download</button>
                    <button id="email-btn" class="btn export email">ğŸ“§ Email</button>
                </div>
            </div>
            <input type="text" id="search" class="search" placeholder="ğŸ” Search...">
            <div id="history-list" class="history-list">
                <p class="empty">No scans yet</p>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="toast hidden"></div>
    </div>

    <!-- Crop Modal -->
    <div id="crop-modal" class="modal hidden">
        <div class="modal-content">
            <h3>âœ‚ï¸ Crop Label</h3>
            <p>Drag box to move, drag corners to resize</p>
            <div id="crop-container" class="crop-container">
                <img id="crop-image" src="" alt="Crop">
                <div id="crop-box" class="crop-box">
                    <div class="resize-handle nw" data-resize="nw"></div>
                    <div class="resize-handle ne" data-resize="ne"></div>
                    <div class="resize-handle sw" data-resize="sw"></div>
                    <div class="resize-handle se" data-resize="se"></div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="crop-skip" class="btn">âŒ Skip</button>
                <button id="crop-confirm" class="btn save">âœ… Crop</button>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="email-modal" class="modal hidden">
        <div class="modal-content email-modal-content">
            <h3>ğŸ“§ Email Export</h3>
            <p>Send scan history as CSV to an email address</p>
            <div class="email-form">
                <div class="field email-field">
                    <label>ğŸ“¬ To:</label>
                    <input type="email" id="email-recipient" list="email-list" placeholder="Enter email address">
                    <datalist id="email-list">
                        <!-- Previously used emails will be populated here -->
                    </datalist>
                </div>
                <div class="email-summary" id="email-summary">
                    <!-- Summary will be populated dynamically -->
                </div>
            </div>
            <div class="modal-actions">
                <button id="email-cancel" class="btn clear">âŒ Cancel</button>
                <button id="email-send" class="btn save">ğŸ“¤ Send Email</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/parser.js"></script>
    <script src="js/ocr.js"></script>
    <script src="js/app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('âœ… Service Worker registered:', registration.scope);
                } catch (err) {
                    console.log('âŒ Service Worker registration failed:', err);
                }
            });
        }

        // Offline/Online status indicator
        function updateOnlineStatus() {
            const isOnline = navigator.onLine;
            const indicator = document.getElementById('offline-indicator');
            if (indicator) {
                indicator.style.display = isOnline ? 'none' : 'flex';
            }
            console.log(isOnline ? 'ğŸŒ Online' : 'ğŸ“´ Offline');
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        document.addEventListener('DOMContentLoaded', updateOnlineStatus);
    </script>

    <!-- Offline Indicator Banner -->
    <div id="offline-indicator"
        style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; padding: 8px 16px; text-align: center; font-size: 14px; font-weight: 600; z-index: 10000; align-items: center; justify-content: center; gap: 8px;">
        ğŸ“´ Offline Mode - OCR will use local processing
    </div>
</body>

</html>